# OrbitEOS Home Assistant Automations
# Using OpenEMS integration sensor names

# Low Battery Alert
- id: 'low_battery_alert'
  alias: Low Battery SOC Alert
  description: 'Notify when battery SOC drops below 20%'
  trigger:
    - platform: numeric_state
      entity_id: sensor.c85ec50313dc_sum_esssoc_2
      below: 20
  action:
    - service: persistent_notification.create
      data:
        title: "Low Battery Warning"
        message: "Battery SOC is {{ states('sensor.c85ec50313dc_sum_esssoc_2') }}%. Consider reducing consumption or enabling grid charging."
        notification_id: low_battery
  mode: single

# High Solar Production Notification
- id: 'high_solar_production'
  alias: High Solar Production Alert
  description: 'Notify when solar production exceeds 5kW'
  trigger:
    - platform: numeric_state
      entity_id: sensor.c85ec50313dc_sum_productionactivepower_2
      above: 5000
  action:
    - service: persistent_notification.create
      data:
        title: "High Solar Production"
        message: "Solar is producing {{ (states('sensor.c85ec50313dc_sum_productionactivepower_2') | float / 1000) | round(2) }} kW! Great time to run appliances."
        notification_id: high_solar
  mode: single

# Grid Export Notification
- id: 'grid_export_started'
  alias: Grid Export Started
  description: 'Notify when exporting to grid'
  trigger:
    - platform: numeric_state
      entity_id: sensor.c85ec50313dc_sum_gridactivepower_2
      below: -500
      for:
        minutes: 1
  action:
    - service: persistent_notification.create
      data:
        title: "Exporting to Grid"
        message: "Now exporting {{ (states('sensor.c85ec50313dc_sum_gridactivepower_2') | float | abs / 1000) | round(2) }} kW to the grid."
        notification_id: grid_export
  mode: single

# Battery Full Notification
- id: 'battery_full'
  alias: Battery Full Notification
  description: 'Notify when battery is fully charged'
  trigger:
    - platform: numeric_state
      entity_id: sensor.c85ec50313dc_sum_esssoc_2
      above: 95
  action:
    - service: persistent_notification.create
      data:
        title: "Battery Full"
        message: "Battery is now at {{ states('sensor.c85ec50313dc_sum_esssoc_2') }}%. Excess solar will be exported to grid."
        notification_id: battery_full
  mode: single

# Morning Solar Start
- id: 'morning_solar_start'
  alias: Morning Solar Production Start
  description: 'Log when solar starts producing in the morning'
  trigger:
    - platform: numeric_state
      entity_id: sensor.c85ec50313dc_sum_productionactivepower_2
      above: 100
  condition:
    - condition: sun
      after: sunrise
  action:
    - service: logbook.log
      data:
        name: Solar
        message: "Solar production started for the day"
        entity_id: sensor.c85ec50313dc_sum_productionactivepower_2
  mode: single

# Peak Rate Warning
- id: 'peak_rate_warning'
  alias: Peak Rate Warning
  description: 'Warn during peak electricity rate hours'
  trigger:
    - platform: time
      at: "17:00:00"
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
  action:
    - service: persistent_notification.create
      data:
        title: "Peak Rate Period"
        message: "Peak electricity rates now in effect (17:00-21:00). Consider using stored solar energy."
        notification_id: peak_rate
  mode: single

# Smart EV Charging - Start when solar excess
- id: 'smart_ev_charging_start'
  alias: Smart EV Charging Start
  description: 'Start EV charging when excess solar available'
  trigger:
    - platform: numeric_state
      entity_id: sensor.c85ec50313dc_sum_gridactivepower_2
      below: -3000
      for:
        minutes: 5
  condition:
    - condition: state
      entity_id: input_boolean.ev_smart_charging
      state: 'on'
  action:
    - service: logbook.log
      data:
        name: EV Charger
        message: "Starting EV charging due to excess solar ({{ (states('sensor.c85ec50313dc_sum_gridactivepower_2') | float | abs / 1000) | round(2) }} kW available)"
  mode: single

# Daily Energy Summary
- id: 'daily_energy_summary'
  alias: Daily Energy Summary
  description: 'Generate daily energy summary at 21:00'
  trigger:
    - platform: time
      at: "21:00:00"
  action:
    - service: persistent_notification.create
      data:
        title: "Daily Energy Summary"
        message: >
          Today's Energy Summary:
          - Solar Production: {{ states('sensor.solar_energy_production') }} kWh
          - Grid Import: {{ states('sensor.grid_energy_import') }} kWh
          - Grid Export: {{ states('sensor.grid_energy_export') }} kWh
        notification_id: daily_summary
  mode: single
