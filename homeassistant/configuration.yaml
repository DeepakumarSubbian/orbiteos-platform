# OrbitEOS Home Assistant Configuration
# Using ha_openems integration for OpenEMS connection

homeassistant:
  name: OrbitEOS Home
  unit_system: metric
  currency: EUR
  country: NL
  time_zone: Europe/Amsterdam
  external_url: "http://localhost:8123"
  internal_url: "http://localhost:8123"

# Enable default config
default_config:

# HTTP configuration
http:
  server_port: 8123

# Logger
logger:
  default: warning
  logs:
    custom_components.openems: debug

# MQTT is configured via UI integration

# Input booleans for control
input_boolean:
  ev_smart_charging:
    name: EV Smart Charging
    icon: mdi:car-electric

  battery_grid_charging:
    name: Allow Battery Grid Charging
    icon: mdi:battery-charging

  solar_priority_mode:
    name: Solar Priority Mode
    icon: mdi:solar-power

# Input numbers for settings
input_number:
  battery_min_soc:
    name: Battery Minimum SOC
    min: 5
    max: 50
    step: 5
    unit_of_measurement: "%"
    icon: mdi:battery-low

  ev_target_soc:
    name: EV Target SOC
    min: 50
    max: 100
    step: 10
    unit_of_measurement: "%"
    icon: mdi:car-battery

# Template sensors for battery charge/discharge power (split from single value)
template:
  - sensor:
      - name: "Battery Charge Power"
        unique_id: battery_charge_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set power = states('sensor.c85ec50313dc_sum_essactivepower_2') | float(0) %}
          {{ max(0, power) }}

      - name: "Battery Discharge Power"
        unique_id: battery_discharge_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set power = states('sensor.c85ec50313dc_sum_essactivepower_2') | float(0) %}
          {{ max(0, -power) }}

      - name: "Grid Import Power"
        unique_id: grid_import_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set power = states('sensor.c85ec50313dc_sum_gridactivepower_2') | float(0) %}
          {{ max(0, power) }}

      - name: "Grid Export Power"
        unique_id: grid_export_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set power = states('sensor.c85ec50313dc_sum_gridactivepower_2') | float(0) %}
          {{ max(0, -power) }}

# Riemann sum integral sensors to convert power to energy
sensor:
  - platform: integration
    source: sensor.c85ec50313dc_sum_productionactivepower_2
    name: Solar Energy Production
    unique_id: solar_energy_production
    unit_prefix: k
    round: 2
    method: left

  - platform: integration
    source: sensor.grid_import_power
    name: Grid Energy Import
    unique_id: grid_energy_import
    unit_prefix: k
    round: 2
    method: left

  - platform: integration
    source: sensor.grid_export_power
    name: Grid Energy Export
    unique_id: grid_energy_export
    unit_prefix: k
    round: 2
    method: left

  - platform: integration
    source: sensor.battery_charge_power
    name: Battery Charge Energy
    unique_id: battery_charge_energy
    unit_prefix: k
    round: 2
    method: left

  - platform: integration
    source: sensor.battery_discharge_power
    name: Battery Discharge Energy
    unique_id: battery_discharge_energy
    unit_prefix: k
    round: 2
    method: left

# Recorder for history
recorder:
  purge_keep_days: 30
  include:
    domains:
      - sensor
      - binary_sensor
      - input_boolean
      - input_number

# Automation placeholder
automation: !include automations.yaml

# Scripts placeholder
script: !include scripts.yaml

# Scenes placeholder
scene: !include scenes.yaml
